dev.off()
##################################################################################################
######                         MAKE                                            ##############
##################################################################################################
#1. UK
UK_make_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
##################################################################################################
######                         MAKE                                            ##############
##################################################################################################
#1. UK
UK_make_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_make_catogory_df <- read.csv(UK_make_dir,stringsAsFactors = F)
UK_make_catogory_df$Cohort_NAME <- "UK"
#1. UK
UK_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_catogory_df <- read.csv(UK_dir,stringsAsFactors = F)
UK_catogory_df$Cohort_NAME <- "UK"
source("TAKI_Ultility.R")
library(ggplot2)
process_catogory_data_func <- function(predicted_catogory_df){
#predicted_catogory_df <- UK_mortality_catogory_df
predicted_catogory_df$NUM_PTs_PredINCatogory <- NA
predicted_catogory_df$NUM_PTs_OUTCOME1 <- NA
predicted_catogory_df$PERC_PTs_OUTCOME1 <- NA
for (i in 1:nrow(predicted_catogory_df)){
predicted_catogory_df[i,"NUM_PTs_PredINCatogory"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_PredictedInCategory"],split = " "))[1])
predicted_catogory_df[i,"NUM_PTs_OUTCOME1"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_AcutalLabel1"],split = " "))[1])
predicted_catogory_df[i,"PERC_PTs_OUTCOME1"] <- round((predicted_catogory_df[i,"NUM_PTs_OUTCOME1"]/predicted_catogory_df[i,"NUM_PTs_PredINCatogory"])*100,2)
}
#order the levels
predicted_catogory_df$Risk_Category <- factor(predicted_catogory_df$Risk_Category, levels = c("<=10%","(10%, 20%]", "(20%, 30%]", "(30%, 40%]", "(40%, 50%]", "(50%, 60%]", "(60%, 70%]", ">70%"))
return(predicted_catogory_df)
}
plot_risk_categoryAndIncidence_func <- function(plot_data,y_left_max,outcome_name){
p<-ggplot(data=plot_data, aes(x=Risk_Category, y=NUM_PTs_PredINCatogory)) +
geom_bar(aes(fill = Cohort_NAME), position=position_dodge(),stat="identity")+
scale_fill_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue4", "firebrick4")) +
geom_point(aes(x = Risk_Category, y = 20*PERC_PTs_OUTCOME1,shape = Cohort_NAME,color = Cohort_NAME), size = 5) + #scale the second y by 12
scale_shape_manual(breaks = c("UK", "UTSW"), values=c(15, 19)) +
geom_line(aes(x = Risk_Category, y = 20*PERC_PTs_OUTCOME1, group = Cohort_NAME,color = Cohort_NAME), size = 1) + #scale the second y by 12
scale_y_continuous(limits = c(0, y_left_max), breaks = seq(0, y_left_max, by = 200),
sec.axis = sec_axis(~./20, name = "Outcome Incidence (%)")) +     # adds the secondary Y-axis
scale_color_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue3", "firebrick3")) +
labs(x= "Predicted Risk Category", y = "Number of Patients", title = paste("Predicted Risk vs.",outcome_name,"Incidence"))+
theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.line = element_line(colour = "black", size = 1, linetype = "solid"),
axis.title = element_text(size = 14),
axis.text = element_text(size = 12),
axis.title.x = element_text(margin =ggplot2::margin(t = 10, r = 0, b = 0, l = 0)),
axis.title.y.left =  element_text(margin =ggplot2::margin(t = 0, r = 5, b = 0, l = 0)),
axis.title.y.right =  element_text(margin =ggplot2::margin(t = 0, r = 0, b = 0, l = 15)),
legend.position = "top",
legend.title = element_blank(),
legend.text =  element_text(size = 14),
plot.title = element_text(hjust = 0.5, size = 16))
return(p)
}
proj_dir  <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/"
#1. UK
UK_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_catogory_df <- read.csv(UK_dir,stringsAsFactors = F)
UK_catogory_df$Cohort_NAME <- "UK"
#2.UTSW
UTSW_dir <- paste0(proj_dir,"ExternalV_performance/make120_drop50/UTSW_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UTSW_catogory_df <- read.csv(UTSW_dir,stringsAsFactors = F)
UTSW_catogory_df$Cohort_NAME <- "UTSW"
#3.Cobine two and get plot data
comb_mortality_category_df <- rbind(UK_catogory_df,UTSW_catogory_df)
#3.Cobine two and get plot data
comb_category_df <- rbind(UK_catogory_df,UTSW_catogory_df)
plot_data <- process_catogory_data_func(comb_category_df)
#plot
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name)
print(p)
plot_data
View(plot_data)
process_catogory_data_func <- function(predicted_catogory_df){
#predicted_catogory_df <- UK_mortality_catogory_df
predicted_catogory_df$NUM_PTs_PredINCatogory <- NA
predicted_catogory_df$NUM_PTs_OUTCOME1 <- NA
predicted_catogory_df$PERC_PTs_OUTCOME1 <- NA
for (i in 1:nrow(predicted_catogory_df)){
predicted_catogory_df[i,"NUM_PTs_PredINCatogory"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_PredictedInCategory"],split = " "))[1])
predicted_catogory_df[i,"NUM_PTs_OUTCOME1"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_AcutalLabel1"],split = " "))[1])
if (predicted_catogory_df[i,"NUM_PTs_OUTCOME1"] == 0){
predicted_catogory_df[i,"PERC_PTs_OUTCOME1"] <- 0
}else{
predicted_catogory_df[i,"PERC_PTs_OUTCOME1"] <- round((predicted_catogory_df[i,"NUM_PTs_OUTCOME1"]/predicted_catogory_df[i,"NUM_PTs_PredINCatogory"])*100,2)
}
}
#order the levels
predicted_catogory_df$Risk_Category <- factor(predicted_catogory_df$Risk_Category, levels = c("<=10%","(10%, 20%]", "(20%, 30%]", "(30%, 40%]", "(40%, 50%]", "(50%, 60%]", "(60%, 70%]", ">70%"))
return(predicted_catogory_df)
}
#1. UK
UK_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_catogory_df <- read.csv(UK_dir,stringsAsFactors = F)
UK_catogory_df$Cohort_NAME <- "UK"
#2.UTSW
UTSW_dir <- paste0(proj_dir,"ExternalV_performance/make120_drop50/UTSW_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UTSW_catogory_df <- read.csv(UTSW_dir,stringsAsFactors = F)
UTSW_catogory_df$Cohort_NAME <- "UTSW"
#3.Cobine two and get plot data
comb_category_df <- rbind(UK_catogory_df,UTSW_catogory_df)
plot_data <- process_catogory_data_func(comb_category_df)
0/0
6/0
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/3E_PlotPredRisk_Catogory.R', echo=TRUE)
print(p)
plot_risk_categoryAndIncidence_func <- function(plot_data,y_left_max,outcome_name,scale_2nd_y){
p<-ggplot(data=plot_data, aes(x=Risk_Category, y=NUM_PTs_PredINCatogory)) +
geom_bar(aes(fill = Cohort_NAME), position=position_dodge(),stat="identity")+
scale_fill_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue4", "firebrick4")) +
geom_point(aes(x = Risk_Category, y = scale_2nd_y*PERC_PTs_OUTCOME1,shape = Cohort_NAME,color = Cohort_NAME), size = 5) + #scale the second y by 12
scale_shape_manual(breaks = c("UK", "UTSW"), values=c(15, 19)) +
geom_line(aes(x = Risk_Category, y = scale_2nd_y*PERC_PTs_OUTCOME1, group = Cohort_NAME,color = Cohort_NAME), size = 1) + #scale the second y by 12
scale_y_continuous(limits = c(0, y_left_max), breaks = seq(0, y_left_max, by = 200),
sec.axis = sec_axis(~./scale_2nd_y, name = "Outcome Incidence (%)")) +     # adds the secondary Y-axis
scale_color_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue3", "firebrick3")) +
labs(x= "Predicted Risk Category", y = "Number of Patients", title = paste("Predicted Risk vs.",outcome_name,"Incidence"))+
theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.line = element_line(colour = "black", size = 1, linetype = "solid"),
axis.title = element_text(size = 14),
axis.text = element_text(size = 12),
axis.title.x = element_text(margin =ggplot2::margin(t = 10, r = 0, b = 0, l = 0)),
axis.title.y.left =  element_text(margin =ggplot2::margin(t = 0, r = 5, b = 0, l = 0)),
axis.title.y.right =  element_text(margin =ggplot2::margin(t = 0, r = 0, b = 0, l = 15)),
legend.position = "top",
legend.title = element_blank(),
legend.text =  element_text(size = 14),
plot.title = element_text(hjust = 0.5, size = 16))
return(p)
}
source("TAKI_Ultility.R")
library(ggplot2)
process_catogory_data_func <- function(predicted_catogory_df){
#predicted_catogory_df <- UK_mortality_catogory_df
predicted_catogory_df$NUM_PTs_PredINCatogory <- NA
predicted_catogory_df$NUM_PTs_OUTCOME1 <- NA
predicted_catogory_df$PERC_PTs_OUTCOME1 <- NA
for (i in 1:nrow(predicted_catogory_df)){
predicted_catogory_df[i,"NUM_PTs_PredINCatogory"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_PredictedInCategory"],split = " "))[1])
predicted_catogory_df[i,"NUM_PTs_OUTCOME1"] <- as.numeric(unlist(strsplit(predicted_catogory_df[i,"N_andPerc_AcutalLabel1"],split = " "))[1])
if (predicted_catogory_df[i,"NUM_PTs_OUTCOME1"] == 0 | predicted_catogory_df[i,"NUM_PTs_PredINCatogory"] == 0){
predicted_catogory_df[i,"PERC_PTs_OUTCOME1"] <- 0
}else{
predicted_catogory_df[i,"PERC_PTs_OUTCOME1"] <- round((predicted_catogory_df[i,"NUM_PTs_OUTCOME1"]/predicted_catogory_df[i,"NUM_PTs_PredINCatogory"])*100,2)
}
}
#order the levels
predicted_catogory_df$Risk_Category <- factor(predicted_catogory_df$Risk_Category, levels = c("<=10%","(10%, 20%]", "(20%, 30%]", "(30%, 40%]", "(40%, 50%]", "(50%, 60%]", "(60%, 70%]", ">70%"))
return(predicted_catogory_df)
}
plot_risk_categoryAndIncidence_func <- function(plot_data,y_left_max,outcome_name,scale_2nd_y){
p<-ggplot(data=plot_data, aes(x=Risk_Category, y=NUM_PTs_PredINCatogory)) +
geom_bar(aes(fill = Cohort_NAME), position=position_dodge(),stat="identity")+
scale_fill_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue4", "firebrick4")) +
geom_point(aes(x = Risk_Category, y = scale_2nd_y*PERC_PTs_OUTCOME1,shape = Cohort_NAME,color = Cohort_NAME), size = 5) + #scale the second y by 12
scale_shape_manual(breaks = c("UK", "UTSW"), values=c(15, 19)) +
geom_line(aes(x = Risk_Category, y = scale_2nd_y*PERC_PTs_OUTCOME1, group = Cohort_NAME,color = Cohort_NAME), size = 1) + #scale the second y by 12
scale_y_continuous(limits = c(0, y_left_max), breaks = seq(0, y_left_max, by = 200),
sec.axis = sec_axis(~./scale_2nd_y, name = "Outcome Incidence (%)")) +     # adds the secondary Y-axis
scale_color_manual(breaks = c("UK", "UTSW"),values=c("dodgerblue3", "firebrick3")) +
labs(x= "Predicted Risk Category", y = "Number of Patients", title = paste("Predicted Risk vs.",outcome_name,"Incidence"))+
theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(axis.line = element_line(colour = "black", size = 1, linetype = "solid"),
axis.title = element_text(size = 14),
axis.text = element_text(size = 12),
axis.title.x = element_text(margin =ggplot2::margin(t = 10, r = 0, b = 0, l = 0)),
axis.title.y.left =  element_text(margin =ggplot2::margin(t = 0, r = 5, b = 0, l = 0)),
axis.title.y.right =  element_text(margin =ggplot2::margin(t = 0, r = 0, b = 0, l = 15)),
legend.position = "top",
legend.title = element_blank(),
legend.text =  element_text(size = 14),
plot.title = element_text(hjust = 0.5, size = 16))
return(p)
}
proj_dir  <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/"
##################################################################################################
######                         Mortality                                            ##############
##################################################################################################
#1. UK
UK_mortality_dir <- paste0(proj_dir,"CV_performance/mortality/UK_SelectedClinicalFeature15Vars_Mortality_Risk_Catogory5_RF.csv")
UK_mortality_catogory_df <- read.csv(UK_mortality_dir,stringsAsFactors = F)
UK_mortality_catogory_df$Cohort_NAME <- "UK"
#2.UTSW
UTSW_mortality_dir <- paste0(proj_dir,"ExternalV_performance/mortality/UTSW_SelectedClinicalFeature15Vars_Mortality_Risk_Catogory5_RF.csv")
UTSW_mortality_catogory_df <- read.csv(UTSW_mortality_dir,stringsAsFactors = F)
UTSW_mortality_catogory_df$Cohort_NAME <- "UTSW"
#3.Cobine two and get plot data
comb_mortality_category_df <- rbind(UK_mortality_catogory_df,UTSW_mortality_catogory_df)
plot_mortality_data <- process_catogory_data_func(comb_mortality_category_df)
#plot
outcome_name <- "Mortality"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 20
p <- plot_risk_categoryAndIncidence_func(plot_mortality_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
#1. UK
UK_dir <- paste0(proj_dir,"CV_performance/make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_catogory_df <- read.csv(UK_dir,stringsAsFactors = F)
UK_catogory_df$Cohort_NAME <- "UK"
#2.UTSW
UTSW_dir <- paste0(proj_dir,"ExternalV_performance/make120_drop50/UTSW_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UTSW_catogory_df <- read.csv(UTSW_dir,stringsAsFactors = F)
UTSW_catogory_df$Cohort_NAME <- "UTSW"
#3.Cobine two and get plot data
comb_category_df <- rbind(UK_catogory_df,UTSW_catogory_df)
plot_data <- process_catogory_data_func(comb_category_df)
#plot
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 10
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
print(p)
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 15
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
print(p)
scale_2nd_y <- 14
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 13
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 15
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 18
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 17
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 15
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
#1. UK
UK_dir <- paste0(proj_dir,"CV_performance/Surviors_make120_drop50/UK_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UK_catogory_df <- read.csv(UK_dir,stringsAsFactors = F)
UK_catogory_df$Cohort_NAME <- "UK"
#2.UTSW
UTSW_dir <- paste0(proj_dir,"ExternalV_performance/Surviors_make120_drop50/UTSW_SelectedClinicalFeature14Vars_MAKE_Risk_Catogory5_RF.csv")
UTSW_catogory_df <- read.csv(UTSW_dir,stringsAsFactors = F)
UTSW_catogory_df$Cohort_NAME <- "UTSW"
#3.Cobine two and get plot data
comb_category_df <- rbind(UK_catogory_df,UTSW_catogory_df)
plot_data <- process_catogory_data_func(comb_category_df)
#plot
outcome_name <- "MAKE_Survivors"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 15
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
outcome_name <- "MAKE_Survivors"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 20
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
#plot
outcome_name <- "MAKE_Survivors"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 20
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=500)
print(p)
dev.off()
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/3E_PlotPredRisk_Catogory.R', echo=TRUE)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/3E_PlotPredRisk_Catogory.R', echo=TRUE)
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=9, height=7, res=300)
print(p)
dev.off()
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=8, res=300)
print(p)
dev.off()
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=10, res=300)
print(p)
dev.off()
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=6, res=300)
print(p)
dev.off()
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=7, res=300)
print(p)
dev.off()
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/3E_PlotPredRisk_Catogory.R', echo=TRUE)
#plot
outcome_name <- "MAKE (Survivors)"
max_n_pts_inCategory <- 1250
scale_2nd_y <- 20
p <- plot_risk_categoryAndIncidence_func(plot_data,max_n_pts_inCategory,outcome_name,scale_2nd_y)
p
tiff(paste0(proj_dir,"RiskCategory_Plot/",outcome_name,".tiff"), units="in", width=10, height=7, res=300)
print(p)
dev.off()
source("TAKI_Ultility.R")
proj_dir  <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/"
###############################################################
#1. For mortality, compare models with IDI, NRI
###############################################################
#1. For UK
perf_dir <- paste0(proj_dir,"CV_performance/mortality/")
baseline_model_file  <- "/SOFA/Prediction_RF.csv"
comprison_model_file1 <- "/APACHE/Prediction_RF.csv"
comprison_model_file2 <- "/SelectedClinicalFeature15Vars/Prediction_RF.csv"
reclass_res1 <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res1)[2] <- paste0("APACHEvsSOFA_",colnames(reclass_res1)[2])
reclass_res2 <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file2,cutoff = c(0,0.5,1))
colnames(reclass_res2)[2] <- paste0("SelectedClinicalFeature15VarsvsSOFA_",colnames(reclass_res2)[2])
comb_res <- cbind(reclass_res1,reclass_res2)
write.csv(comb_res,paste0(perf_dir,"UK_SelectedClinicalFeature15Vars_Mortality_ReclassResults_RF.csv"))
#2. UTSW
perf_dir <- paste0(proj_dir,"ExternalV_performance/mortality/")
baseline_model_file  <- "/SOFA/Prediction_RF.csv"
comprison_model_file1 <- "/APACHE/Prediction_RF.csv"
comprison_model_file2 <- "/SelectedClinicalFeature15Vars/Prediction_RF.csv"
reclass_res1 <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res1)[2] <- paste0("APACHEvsSOFA_",colnames(reclass_res1)[2])
reclass_res2 <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file2,cutoff = c(0,0.5,1))
colnames(reclass_res2)[2] <- paste0("SelectedClinicalFeature15VarsvsSOFA_",colnames(reclass_res2)[2])
comb_res <- cbind(reclass_res1,reclass_res2)
write.csv(comb_res,paste0(perf_dir,"UTSW_SelectedClinicalFeature15Vars_Mortality_ReclassResults_RF.csv"))
#1.UK
perf_dir <- paste0(proj_dir,"CV_performance/make120_drop50/")
baseline_model_file  <- "/KDIGO/Prediction_RF.csv"
comprison_model_file1 <- "/SelectedClinicalFeature14Vars/Prediction_RF.csv"
reclass_res <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res)[2] <- paste0("SelectedClinicalFeature14VarsvsKDIGO_",colnames(reclass_res)[2])
write.csv(reclass_res,paste0(perf_dir,"UK_SelectedClinicalFeature14Vars_MAKE_ReclassResults_RF.csv"))
#UTSW
perf_dir <- paste0(proj_dir,"ExternalV_performance/make120_drop50/")
baseline_model_file  <- "/KDIGO/Prediction_RF.csv"
comprison_model_file1 <- "/SelectedClinicalFeature14Vars/Prediction_RF.csv"
reclass_res <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res)[2] <- paste0("SelectedClinicalFeature14VarsvsKDIGO_",colnames(reclass_res)[2])
write.csv(reclass_res,paste0(perf_dir,"UTSW_SelectedClinicalFeature14Varsl_MAKE_ReclassResults_RF.csv"))
#UTSW
perf_dir <- paste0(proj_dir,"ExternalV_performance/make120_drop50/")
baseline_model_file  <- "/KDIGO/Prediction_RF.csv"
comprison_model_file1 <- "/SelectedClinicalFeature14Vars/Prediction_RF.csv"
reclass_res <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res)[2] <- paste0("SelectedClinicalFeature14VarsvsKDIGO_",colnames(reclass_res)[2])
write.csv(reclass_res,paste0(perf_dir,"UTSW_SelectedClinicalFeature14Vars_MAKE_ReclassResults_RF.csv"))
#1.UK
perf_dir <- paste0(proj_dir,"CV_performance/Surviors_make120_drop50/")
baseline_model_file  <- "/KDIGO/Prediction_RF.csv"
comprison_model_file1 <- "/SelectedClinicalFeature14Vars/Prediction_RF.csv"
reclass_res <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res)[2] <- paste0("SelectedClinicalFeature14VarsvsKDIGO_",colnames(reclass_res)[2])
write.csv(reclass_res,paste0(perf_dir,"UK_SelectedClinicalFeature14Vars_MAKE_ReclassResults_RF.csv"))
#UTSW
perf_dir <- paste0(proj_dir,"ExternalV_performance/Surviors_make120_drop50/")
baseline_model_file  <- "/KDIGO/Prediction_RF.csv"
comprison_model_file1 <- "/SelectedClinicalFeature14Vars/Prediction_RF.csv"
reclass_res <- compute_IDI_NRI_func(perf_dir,baseline_model_file,comprison_model_file1,cutoff = c(0,0.5,1))
colnames(reclass_res)[2] <- paste0("SelectedClinicalFeature14VarsvsKDIGO_",colnames(reclass_res)[2])
write.csv(reclass_res,paste0(perf_dir,"UTSW_SelectedClinicalFeature14Vars_MAKE_ReclassResults_RF.csv"))
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
table(UTSW_data$ECMO_ICUD0toD3)
table(UTSW_data$MV_ICUD0toD3)
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
write.csv(UK_MissingTable,paste0(out_dir,"Feature_MissingTable_UK.csv"),row.names = F)
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
write.csv(UTSW_MissingTable,paste0(out_dir,"Feature_MissingTable_UTSW.csv"),row.names = F)
####################################################################################
#### supp table 2 Mortality
####################################################################################
selected_features_Mortality <- c("UrineOutput_D0toD3" , "Vasopressor_ICUD0toD3","FI02_D1_HIGH","Platelets_D1_LOW","AGE",
"BUN_D0toD3_HIGH","HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3","PH_D1_LOW","Bilirubin_D1_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3","Hours_inICUD0toD3", "Temperature_D1_LOW", "Temperature_D1_HIGH")
length(selected_features_Mortality)
####################################################################################
#### supp table 2 Mortality
####################################################################################
selected_features_Mortality <- c("UrineOutput_D0toD3" , "Vasopressor_ICUD0toD3","FI02_D1_HIGH","Platelets_D1_LOW","AGE",
"BUN_D0toD3_HIGH","HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3","PH_D1_LOW","Bilirubin_D1_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3","Hours_inICUD0toD3", "Temperature_D1_LOW", "Temperature_D1_HIGH")
#Outdir for mortality
#For UK
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2_sur <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
UK_tb2_die <- compute_stats_func(died_df_UK,"UK_died",selected_features_Mortality)
UK_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
#For UTSW
survived_df_UTSW <- UTSW_data[which(UTSW_data$Death_inHOSP==0),]
died_df_UTSW     <- UTSW_data[which(UTSW_data$Death_inHOSP==1),]
UTSW_tb2_sur <- compute_stats_func(survived_df_UTSW,"UTSW_survived",selected_features_Mortality)
UTSW_tb2_die <- compute_stats_func(died_df_UTSW,"UTSW_died",selected_features_Mortality)
UTSW_comb_tb2 <- cbind(UTSW_tb2_sur,UTSW_tb2_die)
final_supp_tb2 <- cbind(UK_comb_tb2,UTSW_comb_tb2)
final_supp_tb2 <- final_supp_tb2[,-c(3,5,7)]
write.csv(final_supp_tb2,paste0(out_dir,"Supp_table2.csv"),row.names = F)
####################################################################################
#### supp table 3 MAKE
####################################################################################
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW",
"Admit_sCr","Sodium_D1_LOW")
length(selected_features_MAKE)
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW",
"Admit_sCr","Sodium_D1_LOW")
#For UK
MAKE0_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==1),]
UK_tb3_0 <- compute_stats_func(MAKE0_df_UK,"UK_MAKE0",selected_features_MAKE)
UK_tb3_1 <- compute_stats_func(MAKE1_df_UK,"UK_MAKE1",selected_features_MAKE)
UK_comb_tb3 <- cbind(UK_tb3_0,UK_tb3_1)
#For UTSW
MAKE0_df_UTSW     <- UTSW_data[which(UTSW_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UTSW     <- UTSW_data[which(UTSW_data$MAKE_HOSP120_Drop50==1),]
UTSW_tb3_0 <- compute_stats_func(MAKE0_df_UTSW,"UTSW_MAKE0",selected_features_MAKE)
UTSW_tb3_1 <- compute_stats_func(MAKE1_df_UTSW,"UTSW_MAKE1",selected_features_MAKE)
UTSW_comb_tb3 <- cbind(UTSW_tb3_0,UTSW_tb3_1)
final_supp_tb3 <- cbind(UK_comb_tb3,UTSW_comb_tb3)
final_supp_tb3 <- final_supp_tb3[,-c(3,5,7)]
write.csv(final_supp_tb3,paste0(out_dir,"Supp_table3.csv"),row.names = F)
which(UK_data$MV_ICUD0toD3==1 & UK_data$Days_MV_ICUD0toD3==0)
which(UTSW_data$MV_ICUD0toD3==1 & UTSW_data$Days_MV_ICUD0toD3==0)
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA_TOTAL","APACHE_TOTAL","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
comb_supptb4 <- cbind(UK_tb4,UTSW_tb4)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4B_Compute_DiscripStats.R', echo=TRUE)
