risk_count <- count_risk_category(avg_risk,risk_category_list)
risk_count$Risk_cateogry_upperbound     <-   c(risk_category_list,1.0)
#Extract raio of actual postives
risk_count$Proportion_ACUTAL_LABEL1     <-   as.numeric(lapply(strsplit(gsub("\\(|\\)","",risk_count$N_andPerc_AcutalLabel1),split = " "),'[[',2))/100
#order the levels
#risk_count$Risk_Category <- factor(risk_count$Risk_Category, levels = risk_category_names )
return(risk_count)
}
plot_calibration_manually <- function(riskCategory,model_name,risk_category_names){
p <- ggplot(riskCategory, aes(x=Risk_cateogry_upperbound, y=Proportion_ACUTAL_LABEL1)) +
geom_point(color="blue",size = 8)+
#geom_line(color="blue")+
#geom_smooth(method=glm, se=FALSE, linetype="dashed", color="darkred") +
geom_smooth(method=glm, method.args = list(family = "binomial"),
se=FALSE, linetype="dashed", color="darkred",size = 5) +
ylim(0,1) +
labs(title= model_name,x ="Predicted Probability", y = "Ratio of Positives") +
scale_x_continuous(breaks=riskCategory$Risk_cateogry_upperbound,
labels=risk_category_names) +
theme_bw() +
theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
theme(plot.title = element_text(color="black", size=30,face = "bold"),
axis.title = element_text(color="black", size=30,face = "bold"),
axis.text.x  = element_text(color="black", size=25),
axis.text.y  = element_text(color="black", size=25))
return(p)
}
proj_dir  <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/"
outdir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Calibration_Explanation010522/"
##################################################################################################
######                         Mortality                                            ##############
##################################################################################################
outcome_name <- "Mortality"
method_name <- "RF"
UK_mortality_dir <- paste0(proj_dir,"CV_performance/mortality/")
UTSW_mortality_dir <- paste0(proj_dir,"ExternalV_performance/mortality/")
model1 <- "SelectedClinicalFeature15Vars"
model2 <- "SOFA"
model3 <- "APACHE"
risk_category_list <- c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9)
# risk_category_names <- c("<=10%","(10%, 20%]", "(20%, 30%]", "(30%, 40%]",
#                         "(40%, 50%]", "(50%, 60%]", "(60%, 70%]", "(70%, 80%]",
#                         "(80%, 90%]",">90%")
risk_category_names <- c("<=10%","10%-20%", "20%-30%", "30%-40%",
"40%-50%", "50%-60%", "60%-70%", "70%-80%",
"80%-90%",">90%")
#1. UK
UK_riskCategory1     <- compute_avg_pred_risk_and_risk_category2("UK",outcome_name,UK_mortality_dir,method_name,model1,risk_category_list,risk_category_names)
View(UK_riskCategory1)
UK_riskCategory2     <- compute_avg_pred_risk_and_risk_category2("UK",outcome_name,UK_mortality_dir,method_name,model2,risk_category_list,risk_category_names)
View(UK_riskCategory1)
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
summary(UK_data)
summary(UK_data["AGE"])
summary(UK_data["HR_D1_HIGH"])
summary(UK_data["Temperature_D1_HIGH"])
summary(UK_data["Temperature_D1_LOW"])
summary(UK_data["Bilirubin_D1_HIGH"])
summary(UK_data["BUN_D0toD3_HIGH"])
summary(UK_data["FI02_D1_HIGH"])
summary(UK_data["PH_D1_LOW"])
summary(UK_data["Platelets_D1_LOW"])
summary(UK_data["MAX_KDIGO_ICU_D0toD3"])
UK_data["MAX_KDIGO_ICU_D0toD3"]
summary(UK_data["UrineOutput_D0toD3"])
summary(UK_data["BUN_D0toD3_HIGH"])
summary(UK_data["FI02_D1_HIGH"])
summary(UK_data["PH_D1_LOW"])
summary(UK_data["Platelets_D1_LOW"])
summary(UK_data["Hemoglobin_D1_LOW"])
summary(UK_data["Sodium_D1_LOW"])
summary(UK_data["Admit_sCr"])
summary(UK_data["UrineOutput_D0toD3"])
View(UK_data)
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
setwd("~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code")
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
table(UK_data$Death_inHOSP)
outcome_df <- read.csv(paste0(outcome_file,outcome_file),stringsAsFactors = F)
outcome_df <- read.csv(paste0(UK_data_dir,outcome_file),stringsAsFactors = F)
colnames(outcome_df)
outcome_df$Death_HOSPStartTo120
table(outcome_df$Death_HOSPStartTo120)
colnames(outcome_df)
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","Death_HOSPStartTo120","eGFR_Drop50","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
####################################################################################
#### table1. Discriptive stats for All cohaort
#'@NOte: Vasopressor_ICUD0toD3 is the same as  Pressor/Inotrope
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3","Death_inHOSP")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
View(UK_tb4)
####################################################################################
#### table1. Discriptive stats for All cohaort
#'@NOte: Vasopressor_ICUD0toD3 is the same as  Pressor/Inotrope
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3",
"Death_inHOSP","Death_HOSPStartTo120","eGFR_Drop50")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
View(UK_tb4)
UK_data$onRRT_ICUD0toD3
####################################################################################
#### table1. Discriptive stats for All cohaort
#'@NOte: Vasopressor_ICUD0toD3 is the same as  Pressor/Inotrope
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3",
"Death_inHOSP","Death_HOSPStartTo120","eGFR_Drop50","MAKE_HOSP120_Drop50")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
outcome_df <- read.csv(paste0(UK_data_dir,outcome_file),stringsAsFactors = F)
colnames(outcome_df)
make_component_list <- c("Death_HOSPStartTo120","onRRT_Last48hBeforeDischarge","ESRD_120","eGFR_Drop50")
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50",make_component_list)
source("TAKI_Ultility.R")
library(lubridate)
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
make_component_list <- c("Death_HOSPStartTo120","onRRT_Last48hBeforeDischarge","ESRD_120","eGFR_Drop50")
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50",make_component_list)
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3",
"Death_inHOSP","Death_HOSPStartTo120",
"onRRT_Last48hBeforeDischarge","ESRD_120",
"eGFR_Drop50","MAKE_HOSP120_Drop50")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
View(UK_tb4)
199/7354
1612/7354
1959/7354
UK_data$onRRT_Last48hBeforeDischarge
which(is.na(UK_data[,"onRRT_Last48hBeforeDischarge"])==T)
input_df <- UK_data
col_name <- "onRRT_Last48hBeforeDischarge"
input_df[,col_name]
which(is.na(input_df[,col_name])==T)
idxes <- which(is.na(input_df[,col_name])==T)
recode_NAto0_func <- function(input_df,col_name){
idxes <- which(is.na(input_df[,col_name])==T)
input_df[idxes,col_name] <- 0
return(input_df)
}
recode_NAto0_func(UK_data,"onRRT_Last48hBeforeDischarge")
UK_data <- recode_NAto0_func(UK_data,"onRRT_Last48hBeforeDischarge")
UK_data <- recode_NAto0_func(UK_data,"ESRD_120")
UK_data <- recode_NAto0_func(UK_data,"eGFR_Drop50")
####################################################################################
#### table1. Discriptive stats for All cohaort
#'@NOte: Vasopressor_ICUD0toD3 is the same as  Pressor/Inotrope
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3",
"Death_inHOSP","Death_HOSPStartTo120",
"onRRT_Last48hBeforeDischarge","ESRD_120",
"eGFR_Drop50","MAKE_HOSP120_Drop50")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
2382/7374
source("TAKI_Ultility.R")
library(lubridate)
recode_NAto0_func <- function(input_df,col_name){
idxes <- which(is.na(input_df[,col_name])==T)
input_df[idxes,col_name] <- 0
return(input_df)
}
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
make_component_list <- c("Death_HOSPStartTo120","onRRT_Last48hBeforeDischarge","ESRD_120","eGFR_Drop50")
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50",make_component_list)
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
UK_data <- recode_NAto0_func(UK_data,"onRRT_Last48hBeforeDischarge")
UK_data <- recode_NAto0_func(UK_data,"ESRD_120")
UK_data <- recode_NAto0_func(UK_data,"eGFR_Drop50")
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
UTSW_data <- recode_NAto0_func(UTSW_data,"onRRT_Last48hBeforeDischarge")
UTSW_data <- recode_NAto0_func(UTSW_data,"ESRD_120")
UTSW_data <- recode_NAto0_func(UTSW_data,"eGFR_Drop50")
length(idxes)
source("TAKI_Ultility.R")
library(lubridate)
recode_NAto0_func <- function(input_df,col_name){
idxes <- which(is.na(input_df[,col_name])==T)
if (length(idxes) != 0){
input_df[idxes,col_name] <- 0
}
return(input_df)
}
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/uky/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0806/Discrip_Stats/"
####################################################################################
#### 1. Load data
#'@IMPORTANT_NOTE_For_sCr:
#'In "All_Feature_NOTimputed.csv, "Baseline_sCr" contains values measured values with reolved by EPI(Resolve EGFR = 75)
#'But in  add_listofvar_func, for data of discrptiive stats
#'"Baseline_sCr":                measured scr, missings are coded as NA
#'"Baseline_sCr_Resolving75EPI": measured scr, missing are filled with revolsing EPi with 75
#'"Baseline_sCr_RegImputation":  measured scr, and missings are filled with regression model (Refer to function for details)
####################################################################################
feature_file <- "Model_Feature_Outcome/All_Feature_NOTimputed.csv"
outcome_file <- "Model_Feature_Outcome/All_outcome.csv"
make_component_list <- c("Death_HOSPStartTo120","onRRT_Last48hBeforeDischarge","ESRD_120","eGFR_Drop50")
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50",make_component_list)
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
UK_data <- recode_NAto0_func(UK_data,"onRRT_Last48hBeforeDischarge")
UK_data <- recode_NAto0_func(UK_data,"ESRD_120")
UK_data <- recode_NAto0_func(UK_data,"eGFR_Drop50")
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
UTSW_data <- recode_NAto0_func(UTSW_data,"onRRT_Last48hBeforeDischarge")
UTSW_data <- recode_NAto0_func(UTSW_data,"ESRD_120")
UTSW_data <- recode_NAto0_func(UTSW_data,"eGFR_Drop50")
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_data_dir,"UTSW")
####################################################################################
##4. Recode last and max KDIGO 3 and 4
####################################################################################
UK_data <-  recode_KDIGO_func(UK_data,"LAST_KDIGO_ICU_D0toD3")
UK_data <-  recode_KDIGO_func(UK_data,"MAX_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"LAST_KDIGO_ICU_D0toD3")
UTSW_data <-  recode_KDIGO_func(UTSW_data,"MAX_KDIGO_ICU_D0toD3")
var_list <- c("AGE","GENDER","RACE","BMI","CHARLSON_SCORE","TOTAL_ELIX","Diabetes","Hypertension","Baseline_eGFR",
"CKD","CKD_UseDiagTerms","CKD_UseICDCodes",
"SOFA_TOTAL","APACHE_TOTAL","Vasopressor_ICUD0toD3","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr",
"Baseline_sCr_Measured_And_Resolving75EPI",
"Baseline_sCr_OnlyResolving75EPI",
"Baseline_sCr_Measured_And_RegImputation",
"Baseline_sCr_OnlyRegImputation",
"Admit_sCr","Peak_SCr_inICU_D0_D3","LastSCr_inICU_D0_D3","MAX_KDIGO_ICU_D0toD3","LAST_KDIGO_ICU_D0toD3",
"onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3",
"Vasopressor_NUMMeds_ICUD0toD3",
"Death_inHOSP","Death_HOSPStartTo120",
"onRRT_Last48hBeforeDischarge","ESRD_120",
"eGFR_Drop50","MAKE_HOSP120_Drop50")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
comb_supptb4 <- cbind(UK_tb4,UTSW_tb4)
write.csv(comb_supptb4,paste0(out_dir,"table1.csv"),row.names = F)
