#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
c(UK_data[,"Bicarbonate_D1_LOW"], UK_data[,"Bicarbonate_D1_HIGH"])
UK_data[,c("Bicarbonate_D1_LOW","Bicarbonate_D1_HIGH"]
UK_data[,c("Bicarbonate_D1_LOW","Bicarbonate_D1_HIGH")]
rowMeans(UK_data[,c("Bicarbonate_D1_LOW","Bicarbonate_D1_HIGH")])
UK_data[ , "Bicarbonate_D1_AVGof(LOWHIGH)"] <- rowMeans(UK_data[,c("Bicarbonate_D1_LOW","Bicarbonate_D1_HIGH")])
UK_data[ , "Hematocrit_D1_AVGof(LOWHIGH)"] <- rowMeans(UK_data[,c("Hematocrit_D1_LOW","Hematocrit_D1_HIGH")])
UK_data[ , "Hemoglobin_D1_AVGof(LOWHIGH)"] <- rowMeans(UK_data[,c("Hemoglobin_D1_LOW","Hemoglobin_D1_HIGH")])
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA","APACHE","Hospital_LOS","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","MV_days",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
All_time_df$Updated_HOSP_DISCHARGE_DATE
difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]))
difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]),units = "days")
All_time_df$HOSP_LOS <- difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]),units = "days")
View(All_time_df)
add_listofvar_func <- function(input_df,extra_data_dir){
All_time_df <-read.csv(paste0(extra_data_dir,"All_Corrected_Timeinfo.csv"),stringsAsFactors = F)
All_time_df$Days_inHOSP <- difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]),units = "days")
Baseline_eGFR_df <-read.csv(paste0(extra_data_dir,"Baseline_EGFR.csv"),stringsAsFactors = F)
extrat_RRT_df <-read.csv(paste0(extra_data_dir,"All_onRRT_DetailedInfo_ICUD0toD3.csv"),stringsAsFactors = F)
input_df <- add_var_func(input_df,"Days_inHOSP",All_time_df)
input_df <- add_var_func(input_df,"Baseline_eGFR",Baseline_eGFR_df)
input_df <- add_var_func(input_df,"RRTinfo_ICUD0toD3",extrat_RRT_df)
input_df <- add_var_func(input_df,"CRRT_Days_inICUD0toD3",extrat_RRT_df)
input_df <- add_var_func(input_df,"HD_Days_inICUD0toD3",extrat_RRT_df)
input_df$Total_days_HDandCRRT <- input_df[,"CRRT_Days_inICUD0toD3"] + input_df[,"HD_Days_inICUD0toD3"]
input_df[ ,"Bicarbonate_D1_AVGof(LOWHIGH)"] <- rowMeans(input_df[,c("Bicarbonate_D1_LOW","Bicarbonate_D1_HIGH")])
input_df[ ,"Hematocrit_D1_AVGof(LOWHIGH)"]  <- rowMeans(input_df[,c("Hematocrit_D1_LOW","Hematocrit_D1_HIGH")])
input_df[ ,"Hemoglobin_D1_AVGof(LOWHIGH)"]  <- rowMeans(input_df[,c("Hemoglobin_D1_LOW","Hemoglobin_D1_HIGH")])
return(input_df)
}
source("TAKI_Ultility.R")
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/Model_Feature_Outcome/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/Model_Feature_Outcome/"
#intermediate data dir
UK_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
UTSW_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0708/Discrip_Stats/"
####################################################################################
#### 1. Load data
####################################################################################
feature_file <- "All_Feature_NOTimputed.csv"
outcome_file <- "All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_intermediate_data_dir)
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_intermediate_data_dir)
####################################################################################
###2. Missing table
####################################################################################
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
#Comb missing table
identical(UK_MissingTable$Feature, UTSW_MissingTable$Feature) #check if features are in the same order
comb_missing_tb <- cbind(UK_MissingTable,UTSW_MissingTable)
write.csv(comb_missing_tb,paste0(out_dir,"Feature_MissingTable.csv"),row.names = F)
####################################################################################
#### supp table 2 and 3
####################################################################################
selected_features_Mortality <- c("UrineOutput_D0toD3" , "Vasopressor_ICUD0toD3","FI02_D1_HIGH","Platelets_D1_LOW","AGE",
"BUN_D0toD3_HIGH","HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3","PH_D1_LOW","Bilirubin_D1_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3","Hours_inICUD0toD3", "Temperature_D1_LOW", "Temperature_D1_HIGH")
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW")
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA","APACHE","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","MV_days",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
SOFA_APACHE_df <-read.csv(paste0(extra_data_dir,"All_SOFA_APACHE_With_NotImputedFeature.csv"),stringsAsFactors = F)
extra_data_dir <- "UK_intermediate_data_dir"
extra_data_dir <- UK_intermediate_data_dir
input_df <- UK_data
All_time_df <-read.csv(paste0(extra_data_dir,"All_Corrected_Timeinfo.csv"),stringsAsFactors = F)
All_time_df$Days_inHOSP <- difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]),units = "days")
Baseline_eGFR_df <-read.csv(paste0(extra_data_dir,"Baseline_EGFR.csv"),stringsAsFactors = F)
extrat_RRT_df <-read.csv(paste0(extra_data_dir,"All_onRRT_DetailedInfo_ICUD0toD3.csv"),stringsAsFactors = F)
SOFA_APACHE_df <-read.csv(paste0(extra_data_dir,"All_SOFA_APACHE_With_NotImputedFeature.csv"),stringsAsFactors = F)
SOFA_APACHE_df
SOFA_APACHE_df$APACHE_TOTAL
SOFA_APACHE_df$Hematocrit_D1_HIGH
SOFA_APACHE_df
View(SOFA_APACHE_df)
UK_intermediate_data_dir
extra_data_dir <- UTSW_intermediate_data_dir
cohort_name <- "UTSW"
extra_data_dir <- UTSW_intermediate_data_dir
input_df <- UTSW_data
cohort_name <- "UTSW"
if (cohort_name == "UK"){
SOFA_APACHE_df <-read.csv(paste0(extra_data_dir,"All_SOFA_APACHE_With_NotImputedFeature.csv"),stringsAsFactors = F)
}else{
SOFA_APACHE_df <-read.csv(paste0(extra_data_dir,"xilong_extracted/All variables for each patients 07212021.csv"),stringsAsFactors = F)
}
SOFA_APACHE_df$SOFA
which(colnames(SOFA_APACHE_df) == "SOFA")
colnames(SOFA_APACHE_df)[which(colnames(SOFA_APACHE_df) == "APACHE")] <- "APACHE_TOTAL"
SOFA_APACHE_df <-read.csv(paste0(extra_data_dir,"xilong_extracted/All variables for each patients 07212021.csv"),stringsAsFactors = F)
colnames(SOFA_APACHE_df)[which(colnames(SOFA_APACHE_df) == "SOFA")] <- "SOFA_TOTAL"
colnames(SOFA_APACHE_df)[which(colnames(SOFA_APACHE_df) == "APACHE")] <- "APACHE_TOTAL"
input_df <- add_var_func(input_df,"Days_inHOSP",All_time_df)
input_df <- add_var_func(input_df,"Baseline_eGFR",Baseline_eGFR_df)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4_Compute_DiscripStats.R', echo=TRUE)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_intermediate_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_intermediate_data_dir,"UTSW")
####################################################################################
###2. Missing table
####################################################################################
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
#Comb missing table
identical(UK_MissingTable$Feature, UTSW_MissingTable$Feature) #check if features are in the same order
comb_missing_tb <- cbind(UK_MissingTable,UTSW_MissingTable)
write.csv(comb_missing_tb,paste0(out_dir,"Feature_MissingTable.csv"),row.names = F)
####################################################################################
#### supp table 2 and 3
####################################################################################
selected_features_Mortality <- c("UrineOutput_D0toD3" , "Vasopressor_ICUD0toD3","FI02_D1_HIGH","Platelets_D1_LOW","AGE",
"BUN_D0toD3_HIGH","HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3","PH_D1_LOW","Bilirubin_D1_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3","Hours_inICUD0toD3", "Temperature_D1_LOW", "Temperature_D1_HIGH")
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW")
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA","APACHE","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","MV_days",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA_TOTAL","APACHE_TOTAL","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","MV_days",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
library(lubridate)
source("TAKI_Ultility.R")
#Raw data dir
raw_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/Taylors_Data/UKY/raw_csv_files/"
outdir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
##########################################################################################
#1. Load data
##########################################################################################
#1. Analysis Id after exclusion
analysis_ID_df <-read.csv(paste0(outdir,"Final_Analysis_ID.csv"),stringsAsFactors = F)
analysis_ID <- unique(analysis_ID_df[,"STUDY_PATIENT_ID"]) #7354
#2. Corrected Time df
All_time_df <-read.csv(paste0(outdir,"All_Corrected_Timeinfo.csv"),stringsAsFactors = F)
All_time_df <- All_time_df[which(All_time_df$STUDY_PATIENT_ID %in% analysis_ID),] #filter for anlaysis Id only
#3.ORGANSUPP_ECMO
raw_ORGANSUPP_ECMO_df <- read.csv(paste0(raw_dir,"ORGANSUPP_ECMO.csv"),stringsAsFactors = F)
#4.ORGANSUPP_IABP
raw_ORGANSUPP_IABP_df <- read.csv(paste0(raw_dir,"ORGANSUPP_IABP.csv"),stringsAsFactors = F)
#5.ORGANSUPP_VENT
raw_ORGANSUPP_VENT_df <- read.csv(paste0(raw_dir,"ORGANSUPP_VENT.csv"),stringsAsFactors = F)
#6.ORGANSUPP_VAD
raw_ORGANSUPP_VAD_df <- read.csv(paste0(raw_dir,"ORGANSUPP_VAD.csv"),stringsAsFactors = F)
##########################################################################################
#Features to extract :  1. days ECMO in ICU D0-D3
#                       2. days IABP in ICU D0-D3
#                       3. days MV in ICU D0-D3
#                       4. days VAD in ICU D0-D3
##########################################################################################
ECMO_IABP_MV_VAD_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 5))
colnames(ECMO_IABP_MV_VAD_df) <- c("STUDY_PATIENT_ID", "Days_ECMO_ICUD0toD3","Days_IABP_ICUD0toD3",
"Days_MV_ICUD0toD3","Days_VAD_ICUD0toD3")
i <- 1
curr_id <- analysis_ID[i]
ECMO_IABP_MV_VAD_df[i,"STUDY_PATIENT_ID"] <- curr_id
get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_ECMO_df,All_time_df,curr_id,"ECMO_START_DATE","ECMO_STOP_DATE")
##########################################################################################
#Features to extract :  1. days ECMO in ICU D0-D3
#                       2. days IABP in ICU D0-D3
#                       3. days MV in ICU D0-D3
#                       4. days VAD in ICU D0-D3
##########################################################################################
ECMO_IABP_MV_VAD_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 5))
colnames(ECMO_IABP_MV_VAD_df) <- c("STUDY_PATIENT_ID", "Days_ECMO_ICUD0toD3","Days_IABP_ICUD0toD3",
"Days_MV_ICUD0toD3","Days_VAD_ICUD0toD3")
for (i in 1: length(analysis_ID)){
if (i %% 1000== 0){print(i)}
curr_id <- analysis_ID[i]
ECMO_IABP_MV_VAD_df[i,"STUDY_PATIENT_ID"] <- curr_id
ecmo_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_ECMO_df,All_time_df,curr_id,"ECMO_START_DATE","ECMO_STOP_DATE")
IABP_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_IABP_df,All_time_df,curr_id,"IABP_START_DATE","IABP_STOP_DATE")
MV_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_VENT_df,All_time_df,curr_id,"VENT_START_DATE","VENT_STOP_DATE")
VAD_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_VAD_df,All_time_df,curr_id,"VAD_START_DATE","VAD_STOP_DATE")
ECMO_IABP_MV_VAD_df[i,"Days_ECMO_ICUD0toD3"] <- ecmo_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_IABP_ICUD0toD3"] <- IABP_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_MV_ICUD0toD3"]   <- MV_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_VAD_ICUD0toD3"]  <- VAD_res[[2]]
}
IABP_res
ecmo_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_ECMO_df,All_time_df,curr_id,"ECMO_START_DATE","ECMO_STOP_DATE")
IABP_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_IABP_df,All_time_df,curr_id,"IABP_START_DATE","IABP_STOP_DATE")
MV_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_VENT_df,All_time_df,curr_id,"VENT_START_DATE","VENT_STOP_DATE")
VAD_res <- get_onMachine_flag_ICUD0_D3(raw_ORGANSUPP_VAD_df,All_time_df,curr_id,"VAD_START_DATE","VAD_STOP_DATE")
ecmo_res[[2]]
IABP_res[[2]]
for (i in 1: length(analysis_ID)){
if (i %% 1000== 0){print(i)}
curr_id <- analysis_ID[i]
ECMO_IABP_MV_VAD_df[i,"STUDY_PATIENT_ID"] <- curr_id
ecmo_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_ECMO_df,All_time_df,curr_id,"ECMO_START_DATE","ECMO_STOP_DATE")
IABP_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_IABP_df,All_time_df,curr_id,"IABP_START_DATE","IABP_STOP_DATE")
MV_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_VENT_df,All_time_df,curr_id,"VENT_START_DATE","VENT_STOP_DATE")
VAD_res <- get_onMachine_flag_ICUD0_D3_v2(raw_ORGANSUPP_VAD_df,All_time_df,curr_id,"VAD_START_DATE","VAD_STOP_DATE")
ECMO_IABP_MV_VAD_df[i,"Days_ECMO_ICUD0toD3"] <- ecmo_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_IABP_ICUD0toD3"] <- IABP_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_MV_ICUD0toD3"]   <- MV_res[[2]]
ECMO_IABP_MV_VAD_df[i,"Days_VAD_ICUD0toD3"]  <- VAD_res[[2]]
}
write.csv(ECMO_IABP_MV_VAD_df,paste0(outdir,"All_ECMO_IABP_MV_VAD_Days_in_ICUD0toD3.csv"),row.names = F)
View(ECMO_IABP_MV_VAD_df)
source("TAKI_Ultility.R")
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/Model_Feature_Outcome/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/Model_Feature_Outcome/"
#intermediate data dir
UK_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
UTSW_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0708/Discrip_Stats/"
####################################################################################
#### 1. Load data
####################################################################################
feature_file <- "All_Feature_NOTimputed.csv"
outcome_file <- "All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_intermediate_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_intermediate_data_dir,"UTSW")
####################################################################################
###2. Missing table
####################################################################################
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
#Comb missing table
identical(UK_MissingTable$Feature, UTSW_MissingTable$Feature) #check if features are in the same order
comb_missing_tb <- cbind(UK_MissingTable,UTSW_MissingTable)
write.csv(comb_missing_tb,paste0(out_dir,"Feature_MissingTable.csv"),row.names = F)
UK_data$MV_ICUD0toD3
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
source("TAKI_Ultility.R")
#Data dir
UK_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/Model_Feature_Outcome/"
UTSW_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/Model_Feature_Outcome/"
#intermediate data dir
UK_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
UTSW_intermediate_data_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/utsw/"
#out dir
out_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/Intermediate_Results/Prediction_results0708/Discrip_Stats/"
####################################################################################
#### 1. Load data
####################################################################################
feature_file <- "All_Feature_NOTimputed.csv"
outcome_file <- "All_outcome.csv"
outcome_colname_list <- c("Death_inHOSP","MAKE_HOSP120_Drop50")
#For UK
UK_data <- Combine_featureAndoutcomes_func(UK_data_dir,feature_file,outcome_file,outcome_colname_list)
#For UTSW
UTSW_data <- Combine_featureAndoutcomes_func(UTSW_data_dir,feature_file,outcome_file,outcome_colname_list)
####################################################################################
###3.Add some variables
####################################################################################
#For UK
UK_data <- add_listofvar_func(UK_data,UK_intermediate_data_dir,"UK")
#For UTSW
UTSW_data <- add_listofvar_func(UTSW_data,UTSW_intermediate_data_dir,"UTSW")
####################################################################################
###2. Missing table
####################################################################################
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
#Comb missing table
identical(UK_MissingTable$Feature, UTSW_MissingTable$Feature) #check if features are in the same order
comb_missing_tb <- cbind(UK_MissingTable,UTSW_MissingTable)
UTSW_MissingTable
#For UK
UK_MissingTable <- get_missing_rate_table(UK_data,colnames(UK_data))
colnames(UK_MissingTable)[2] <- paste0("UK_",colnames(UK_MissingTable)[2])
write.csv(comb_missing_tb,paste0(out_dir,"Feature_MissingTable_UK.csv"),row.names = F)
#For UTSW
UTSW_MissingTable <- get_missing_rate_table(UTSW_data,colnames(UTSW_data))
colnames(UTSW_MissingTable)[2] <- paste0("UTSW_",colnames(UTSW_MissingTable)[2])
write.csv(comb_missing_tb,paste0(out_dir,"Feature_MissingTable_UTSW.csv"),row.names = F)
####################################################################################
#### supp table 2 and 3
####################################################################################
selected_features_Mortality <- c("UrineOutput_D0toD3" , "Vasopressor_ICUD0toD3","FI02_D1_HIGH","Platelets_D1_LOW","AGE",
"BUN_D0toD3_HIGH","HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3","PH_D1_LOW","Bilirubin_D1_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3","Hours_inICUD0toD3", "Temperature_D1_LOW", "Temperature_D1_HIGH")
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW")
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA_TOTAL","APACHE_TOTAL","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
View(UK_tb4)
View(UTSW_tb4)
extra_data_dir <- UTSW_intermediate_data_dir
input_df <- UTSW_data
cohort_name <- "UTSW"
All_time_df <-read.csv(paste0(extra_data_dir,"All_Corrected_Timeinfo.csv"),stringsAsFactors = F)
All_time_df$Days_inHOSP <- difftime(ymd_hms(All_time_df[,"Updated_HOSP_DISCHARGE_DATE"]), ymd_hms(All_time_df[,"Updated_HOSP_ADMIT_DATE"]),units = "days")
Baseline_eGFR_df <-read.csv(paste0(extra_data_dir,"Baseline_EGFR.csv"),stringsAsFactors = F)
extrat_RRT_df <-read.csv(paste0(extra_data_dir,"All_onRRT_DetailedInfo_ICUD0toD3.csv"),stringsAsFactors = F)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4_Compute_DiscripStats.R', echo=TRUE)
####################################################################################
#### supp table4. Discriptive stats for All cohaort
####################################################################################
var_list <- c("AGE","GENDER","RACE","BMI","Charlson","Elixhauser","Diabetes","Hypertension","Baseline_eGFR","CKD",
"SOFA_TOTAL","APACHE_TOTAL","Days_inHOSP","Hours_inICUD0toD3","ECMO_ICUD0toD3","IABP_ICUD0toD3","VAD_ICUD0toD3","MV_ICUD0toD3","Days_MV_ICUD0toD3",
"Sepsis_Before_or_At_Admission","UrineOutput_D0toD3","UrineFlow_D0toD3","FluidOverload_inPercentage",
"Bicarbonate_D1_AVGof(LOWHIGH)","BUN_D0toD3_HIGH","Hematocrit_D1_AVGof(LOWHIGH)","Hemoglobin_D1_AVGof(LOWHIGH)",
"Baseline_sCr","Admit_sCr","Peak_SCr_inICU_D0_D3","Last_SCr_inHOSP","onRRT_ICUD0toD3","RRTinfo_ICUD0toD3",
"CRRT_Days_inICUD0toD3","HD_Days_inICUD0toD3","Total_days_HDandCRRT")
#For UK
UK_tb4 <- compute_stats_func(UK_data,"UK",var_list)
#For UTSW
UTSW_tb4 <- compute_stats_func(UTSW_data,"UTSW",var_list)
colnames(UTSW_tb4)
comb_tb4 <- cbind(UK_tb4,UTSW_tb4)
View(comb_tb4)
comb_supptb4 <- cbind(UK_tb4,UTSW_tb4)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4_Compute_DiscripStats.R', echo=TRUE)
which(UK_data$Death_inHOSP)
which(UK_data$Death_inHOSP==0)
survived_df <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2 <- compute_stats_func(survived_df_UK,"UK_survived",var_list)
#For UK
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2 <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
View(UK_tb2)
####################################################################################
#### supp table 2 Mortality
####################################################################################
selected_features_Mortality <- c("Bilirubin_D1_HIGH","Temperature_D1_LOW", "Temperature_D1_HIGH",
"HR_D1_HIGH","LAST_KDIGO_ICU_D0toD3",
"AGE", "UrineOutput_D0toD3" ,"BUN_D0toD3_HIGH",
"MAX_KDIGO_ICU_D0toD3","ECMO_ICUD0toD3",
"Platelets_D1_LOW","FI02_D1_HIGH","Hours_inICUD0toD3",
"Vasopressor_ICUD0toD3","PH_D1_LOW" )
#For UK
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2 <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
#For UK
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2_sur <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
UK_tb2_die <- compute_stats_func(died_df_UK,"UK_died",selected_features_Mortality)
View(UK_tb2_sur)
UK_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
View(UK_comb_tb2)
#For UTSW
survived_df_UTSW <- UTSW_data[which(UTSW_data$Death_inHOSP==0),]
died_df_UTSW     <- UTSW_data[which(UTSW_data$Death_inHOSP==1),]
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2_sur <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
UK_tb2_die <- compute_stats_func(died_df_UK,"UK_died",selected_features_Mortality)
UK_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
#For UTSW
survived_df_UTSW <- UTSW_data[which(UTSW_data$Death_inHOSP==0),]
died_df_UTSW     <- UTSW_data[which(UTSW_data$Death_inHOSP==1),]
UTSW_tb2_sur <- compute_stats_func(survived_df_UTSW,"UTSW_survived",selected_features_Mortality)
UTSW_tb2_die <- compute_stats_func(died_df_UTSW,"UTSW_died",selected_features_Mortality)
UTSW_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
final_supp_tb2 <- cbind(UK_comb_tb2,UTSW_comb_tb2)
colnames(final_supp_tb2)
final_supp_tb2 <- final_supp_tb2[,c(3,5,7)]
View(final_supp_tb2)
#For UK
survived_df_UK <- UK_data[which(UK_data$Death_inHOSP==0),]
died_df_UK     <- UK_data[which(UK_data$Death_inHOSP==1),]
UK_tb2_sur <- compute_stats_func(survived_df_UK,"UK_survived",selected_features_Mortality)
UK_tb2_die <- compute_stats_func(died_df_UK,"UK_died",selected_features_Mortality)
UK_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
#For UTSW
survived_df_UTSW <- UTSW_data[which(UTSW_data$Death_inHOSP==0),]
died_df_UTSW     <- UTSW_data[which(UTSW_data$Death_inHOSP==1),]
UTSW_tb2_sur <- compute_stats_func(survived_df_UTSW,"UTSW_survived",selected_features_Mortality)
UTSW_tb2_die <- compute_stats_func(died_df_UTSW,"UTSW_died",selected_features_Mortality)
UTSW_comb_tb2 <- cbind(UK_tb2_sur,UK_tb2_die)
final_supp_tb2 <- cbind(UK_comb_tb2,UTSW_comb_tb2)
final_supp_tb2 <- final_supp_tb2[,-c(3,5,7)]
####################################################################################
#### supp table 3 MAKE
####################################################################################
selected_features_MAKE <- c("LAST_KDIGO_ICU_D0toD3","UrineOutput_D0toD3","MAX_KDIGO_ICU_D0toD3","Bilirubin_D1_HIGH",
"AGE","BUN_D0toD3_HIGH","Hemoglobin_D1_LOW","Platelets_D1_LOW","FI02_D1_HIGH",
"Vasopressor_ICUD0toD3","HR_D1_HIGH","PH_D1_LOW")
#For UK
MAKE0_df_UK <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==1),]
UK_tb3_0 <- compute_stats_func(MAKE0_df_UK,"UK_survived",selected_features_Mortality)
UK_tb3_0 <- compute_stats_func(MAKE0_df_UK,"UK_MAKE0",selected_features_Mortality)
#For UK
MAKE0_df_UK <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==0),]
#For UK
MAKE0_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==1),]
UK_tb3_0 <- compute_stats_func(MAKE0_df_UK,"UK_MAKE0",selected_features_MAKE)
UK_tb3_1 <- compute_stats_func(MAKE1_df_UK,"UK_MAKE1",selected_features_MAKE)
View(UK_tb3_0)
#For UK
MAKE0_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UK     <- UK_data[which(UK_data$MAKE_HOSP120_Drop50==1),]
UK_tb3_0 <- compute_stats_func(MAKE0_df_UK,"UK_MAKE0",selected_features_MAKE)
UK_tb3_1 <- compute_stats_func(MAKE1_df_UK,"UK_MAKE1",selected_features_MAKE)
UK_comb_tb3 <- cbind(UK_tb3_0,UK_tb3_1)
#For UTSW
MAKE0_df_UTSW     <- UTSW_data[which(UTSW_data$MAKE_HOSP120_Drop50==0),]
MAKE1_df_UTSW     <- UTSW_data[which(UTSW_data$MAKE_HOSP120_Drop50==1),]
UTSW_tb3_0 <- compute_stats_func(MAKE0_df_UTSW,"UTSW_MAKE0",selected_features_MAKE)
UTSW_tb3_1 <- compute_stats_func(MAKE1_df_UTSW,"UTSW_MAKE1",selected_features_MAKE)
UTSW_comb_tb3 <- cbind(UTSW_tb3_0,UTSW_tb3_1)
final_supp_tb3 <- cbind(UK_comb_tb3,UTSW_comb_tb3)
colnames(final_supp_tb3)
final_supp_tb3 <- final_supp_tb3[,-c(3,5,7)]
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4_Compute_DiscripStats.R', echo=TRUE)
source('~/Desktop/DrChen_Projects/All_AKI_Projects/Other_Project/TAKI_Project/TAKI_Code/4_Compute_DiscripStats.R', echo=TRUE)
